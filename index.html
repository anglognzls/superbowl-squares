<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title id="tab-title">Super Bowl Squares</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <style>
        :root { 
            --blue: #002244; /* Top Team Color */
            --red: #C60C30;  /* Side Team Color */
            --gold: #f39c12; 
            --bg: #121212; 
        }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: #fff; margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        
        .card { background: white; color: #333; padding: 15px; border-radius: 12px; width: 100%; max-width: 900px; margin-bottom: 15px; box-sizing: border-box; box-shadow: 0 4px 15px rgba(0,0,0,0.5); overflow: hidden; }
        
        .table-wrap { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; margin-bottom: 10px; border-radius: 8px; }
        
        #mainTable { border-collapse: collapse; margin: 0 auto; background: white; min-width: 600px; } 
        #mainTable th, #mainTable td { border: 1px solid #ccc; height: 45px; text-align: center; }
        
        .payout-table { width: 100%; min-width: 300px; border-collapse: collapse; }
        .payout-table td { padding: 10px 5px; border-bottom: 1px solid #eee; font-size: 14px; }

        .team-top { background: var(--blue); color: white; font-weight: bold; font-size: 14px; transition: 0.3s; }
        .team-side { background: var(--red); color: white; width: 30px; writing-mode: vertical-rl; transform: rotate(180deg); font-weight: bold; font-size: 14px; transition: 0.3s; }
        .num { background: #eee; font-weight: bold; color: #000; font-size: 1.2rem; width: 40px; }

        input.sq { width: 100%; height: 100%; border: none; text-align: center; background: transparent; font-size: 12px; font-weight: bold; outline: none; color: #333; }
        
        #activity-ticker { background: #333; color: #4caf50; width: 100%; max-width: 900px; padding: 10px; text-align: center; font-size: 14px; font-weight: bold; border-radius: 8px; margin-bottom: 10px; border-left: 5px solid #4caf50; display: none; box-sizing: border-box; }
        .ticker-anim { animation: flash 1s ease-in-out; }
        @keyframes flash { 0% { background: #4caf50; color: white; } 100% { background: #333; color: #4caf50; } }

        .counter-badge { background: var(--red); color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; float: right; font-weight: bold; }
        .winner { background: #fff59d !important; animation: pulse 2s infinite; border: 2px solid var(--gold); }
        @keyframes pulse { 0%, 100% { background: #fff59d; } 50% { background: #ffd54f; } }
        
        button { padding: 10px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; color: white; }
        .btn-main { background: var(--blue); }
        .btn-share { background: #2196F3; font-size: 14px; margin-top: 10px; width: 100%; }
        .btn-gold { background: var(--gold); }
        .btn-reset { background: #607d8b; }
        .color-label { font-size: 11px; color: #666; font-weight: normal; display: block; }

        #chat-display { height: 100px; overflow-y: auto; font-size: 13px; border: 1px solid #ddd; padding: 10px; margin-bottom: 8px; background: #fafafa; border-radius: 4px; }
        
        @media (max-width: 600px) {
            .team-side { width: 20px; font-size: 10px; }
            #mainTable th, #mainTable td { height: 40px; }
            .num { font-size: 1rem; width: 30px; }
        }
    </style>
</head>
<body>

    <h2 id="header-display">üèà Super Bowl LIX</h2>

    <div id="activity-ticker"></div>

    <div class="card" id="admin-fields" style="display:none; background: #fff3e0; border: 2px solid #ffcc80;">
        <h4 style="margin:0 0 10px 0; color: #e65100;">Commissioner Dashboard</h4>
        
        <div style="margin-bottom:15px;">
            <label class="color-label">Display Header Title:</label>
            <input type="text" id="edit-header" placeholder="e.g. Super Bowl 2026" oninput="pushHeader()" style="width:100%; padding:8px; box-sizing:border-box;">
        </div>

        <div style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:12px;">
            <button onclick="toggleLock()" id="lock-btn" class="btn-main">üîí LOCK BOARD</button>
            <button onclick="pushShuffle()" class="btn-gold">üé≤ SHUFFLE</button>
            <button onclick="resetNumbersOnly()" class="btn-reset">‚ùì HIDE NUMS</button>
            <button onclick="globalReset()" style="background: var(--red)">üßπ RESET ALL</button>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
            <div>
                <label class="color-label">Top Team / Color:</label>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="edit-top" placeholder="Top Name" oninput="pushTeams()" style="width:70%">
                    <input type="color" id="color-top" value="#002244" oninput="pushTeams()" style="width:30%; height:35px; border:none; padding:0;">
                </div>
            </div>
            <div>
                <label class="color-label">Side Team / Color:</label>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="edit-side" placeholder="Side Name" oninput="pushTeams()" style="width:70%">
                    <input type="color" id="color-side" value="#C60C30" oninput="pushTeams()" style="width:30%; height:35px; border:none; padding:0;">
                </div>
            </div>
        </div>

        <div style="font-size: 13px;">
            Price: $<input type="number" id="edit-price" style="width:50px" oninput="updatePot()">
            Splits (%): <input type="text" id="payout-split" value="25,25,25,25" style="width:90px" oninput="updatePot()">
        </div>
        <textarea id="rules-editor" style="width:100%; height:50px; margin-top:10px;" oninput="updateRules()" placeholder="Edit house rules here..."></textarea>
    </div>

    <div class="card">
        <div class="counter-badge" id="squares-left">100 Left</div>
        <h4 style="margin:0 0 5px 0">üìú House Rules</h4>
        <div id="rules-text" style="font-size: 14px; white-space: pre-wrap;">Loading rules...</div>
        <button onclick="copyShareLink()" class="btn-share">üîó SHARE WITH FRIENDS</button>
    </div>

    <div class="table-wrap">
        <table id="mainTable">
            <tr id="top-row-label"></tr>
            <tr id="top-nums"></tr>
        </table>
    </div>

    <div class="card">
        <h4 style="margin:0">üèÜ Payouts (Pot: <span id="total-pot">$0</span>)</h4>
        <div class="table-wrap">
            <table class="payout-table">
                <tr><td><b>Q1</b></td><td id="h1">Waiting...</td><td id="p1">$0</td></tr>
                <tr><td><b>Half</b></td><td id="h2">Waiting...</td><td id="p2">$0</td></tr>
                <tr><td><b>Q3</b></td><td id="h3">Waiting...</td><td id="p3">$0</td></tr>
                <tr><td><b>Final</b></td><td id="h4">Waiting...</td><td id="p4">$0</td></tr>
            </table>
        </div>
        <div style="margin-top:5px; border-top: 1px solid #eee; padding-top:10px; text-align:center;">
            <small><b>Live Score Tracker:</b></small><br>
            <span id="label-score-top" style="font-size:12px; font-weight:bold; color:var(--blue)">Top</span>: <input type="number" id="s-top" style="width:40px" oninput="pushScore()">
            <span id="label-score-side" style="font-size:12px; font-weight:bold; color:var(--red)">Side</span>: <input type="number" id="s-side" style="width:40px" oninput="pushScore()">
            <br><button onclick="saveWinnerPrompt()" class="btn-main" style="font-size:11px; margin-top:8px;">üíæ SAVE WINNER</button>
        </div>
    </div>

    <div class="card">
        <div id="chat-display"></div>
        <div style="display:flex; gap:5px;">
            <input type="text" id="chat-name" placeholder="Name" style="width:70px; padding:5px;">
            <input type="text" id="chat-msg" placeholder="Talk smack..." style="flex-grow:1; padding:5px;" onkeypress="if(event.key==='Enter') sendChat()">
            <button onclick="sendChat()" class="btn-main">Send</button>
        </div>
    </div>

    <script>
        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyAyUTAJvlOYwwkQDbn4aIv2T45j8v4cA1g",
            authDomain: "super-bowl-2026-c3939.firebaseapp.com",
            projectId: "super-bowl-2026-c3939",
            databaseURL: "https://super-bowl-2026-c3939-default-rtdb.firebaseio.com",
            storageBucket: "super-bowl-2026-c3939.firebasestorage.app",
            messagingSenderId: "262096718545",
            appId: "1:262096718545:web:497ce0377c36f0333653f0"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const myID = localStorage.getItem('sq_uid') || Math.random().toString(36).slice(2);
        localStorage.setItem('sq_uid', myID);

        const isAdmin = new URLSearchParams(window.location.search).get('pass') === 'Number.02superbowl';
        if (isAdmin) document.getElementById('admin-fields').style.display = 'block';

        let isLocked = false, cellOwnership = {};

        function initGrid() {
            const table = document.getElementById('mainTable');
            document.getElementById('top-row-label').innerHTML = `<th colspan="2" rowspan="2" style="border:none"></th><th colspan="10" class="team-top" id="label-top">TOP</th>`;
            for(let r=0; r<10; r++) {
                let row = document.createElement('tr');
                if(r === 0) row.innerHTML = `<th rowspan="10" class="team-side" id="label-side">SIDE</th>`;
                row.innerHTML += `<th class="num s-n" id="sn-${r}">?</th>`;
                for(let c=0; c<10; c++) row.innerHTML += `<td><input class="sq" id="q${r}${c}" onchange="claimSquare('${r}${c}', this.value)"></td>`;
                table.appendChild(row);
            }
        }
        initGrid();

        // Admin Pushers
        function pushHeader() { if(isAdmin) db.ref('header').set(document.getElementById('edit-header').value); }
        
        function pushTeams() {
            if(!isAdmin) return;
            const data = {
                t: document.getElementById('edit-top').value,
                s: document.getElementById('edit-side').value,
                cT: document.getElementById('color-top').value,
                cS: document.getElementById('color-side').value,
                pass: 'Number.02superbowl'
            };
            db.ref('teams').set(data);
        }

        function copyShareLink() {
            const url = window.location.origin + window.location.pathname;
            navigator.clipboard.writeText(url).then(() => alert("Link Copied!"));
        }

        function updateRules() { if(isAdmin) db.ref('gameRules').set({ text: document.getElementById('rules-editor').value, pass: 'Number.02superbowl' }); }

        function pushShuffle() {
            if(!isAdmin) return;
            const r = () => [0,1,2,3,4,5,6,7,8,9].sort(() => Math.random()-0.5);
            db.ref('nums').set({ t: r(), s: r(), pass: 'Number.02superbowl' });
        }

        function resetNumbersOnly() { if (isAdmin && confirm("Hide numbers?")) db.ref('nums').set({ t: null, s: null, pass: 'Number.02superbowl' }); }

        function globalReset() { if (isAdmin && confirm("WIPE DATABASE?")) { db.ref('/').set({ pass: 'Number.02superbowl' }); location.reload(); } }

        function toggleLock() { if(isAdmin) db.ref('isLocked').set(!isLocked); }

        function saveWinnerPrompt() {
            const q = prompt("Quarter? (1, 2, 3, or 4)");
            if(!["1","2","3","4"].includes(q)) return;
            const winnerCell = document.querySelector('.winner input');
            const winnerName = winnerCell ? winnerCell.value : "Empty Square";
            const score = `${document.getElementById('s-top').value}-${document.getElementById('s-side').value}`;
            db.ref('history/'+q).set({ name: winnerName, score: score });
        }

        function claimSquare(id, val) {
            if(isLocked && !isAdmin) return;
            if(!cellOwnership[id] || cellOwnership[id] === myID || isAdmin) {
                db.ref('names/'+id).set(val);
                db.ref('owners/'+id).set(myID);
                if(val.trim() !== "") db.ref('lastAction').set({ msg: `üî• ${val} grabbed a square!`, time: Date.now() });
            }
        }

        function pushScore() { db.ref('score').set({t:document.getElementById('s-top').value, s:document.getElementById('s-side').value}); }

        function sendChat() {
            const name = document.getElementById('chat-name').value || "Guest", msg = document.getElementById('chat-msg').value;
            if(msg) db.ref('chat').push({ name, msg });
            document.getElementById('chat-msg').value = '';
        }

        // --- LISTENERS ---
        db.ref('header').on('value', s => {
            const val = s.val() || "üèà Super Bowl LIX";
            document.getElementById('header-display').innerText = val;
            document.getElementById('tab-title').innerText = val;
            if(isAdmin) document.getElementById('edit-header').value = val;
        });

        db.ref('isLocked').on('value', s => { 
            isLocked = s.val() || false;
            document.getElementById('lock-btn').innerText = isLocked ? "üîì UNLOCK" : "üîí LOCK";
            document.querySelectorAll('.sq').forEach(i => {
                const id = i.id.replace('q','');
                const foreignOwner = cellOwnership[id] && cellOwnership[id] !== myID;
                i.readOnly = (isLocked && !isAdmin) || (foreignOwner && !isAdmin);
            });
        });

        db.ref('gameRules/text').on('value', s => {
            const val = s.val() || "Click squares to join!";
            document.getElementById('rules-text').innerText = val;
            if(isAdmin) document.getElementById('rules-editor').value = val;
        });

        db.ref('lastAction').on('value', s => {
            const d = s.val(); if(!d) return;
            const t = document.getElementById('activity-ticker');
            t.innerText = d.msg; t.style.display = 'block';
            t.classList.remove('ticker-anim'); void t.offsetWidth; t.classList.add('ticker-anim');
        });

        db.ref('names').on('value', s => { 
            const n = s.val() || {}; 
            document.querySelectorAll('.sq').forEach(i => i.value = n[i.id.replace('q','')] || ''); 
            const left = 100 - Object.keys(n).filter(k => n[k].trim() !== "").length;
            const b = document.getElementById('squares-left');
            b.innerText = left + " Left";
            b.style.background = left <= 10 ? "#f39c12" : (left === 0 ? "#4caf50" : "#C60C30");
        });

        db.ref('owners').on('value', s => { cellOwnership = s.val() || {}; });

        db.ref('teams').on('value', s => { 
            const t = s.val() || {t:'Top Team', s:'Side Team', cT:'#002244', cS:'#C60C30'};
            
            // Update Text
            document.getElementById('label-top').innerText = t.t;
            document.getElementById('label-side').innerText = t.s;
            document.getElementById('label-score-top').innerText = t.t;
            document.getElementById('label-score-side').innerText = t.s;
            
            // Update CSS Variables (Colors)
            document.documentElement.style.setProperty('--blue', t.cT);
            document.documentElement.style.setProperty('--red', t.cS);

            if(isAdmin) {
                document.getElementById('edit-top').value = t.t;
                document.getElementById('edit-side').value = t.s;
                document.getElementById('color-top').value = t.cT;
                document.getElementById('color-side').value = t.cS;
            }
        });

        db.ref('nums').on('value', s => { 
            const n = s.val(); 
            if(!n || !n.t || !n.s) {
                document.getElementById('top-nums').innerHTML = Array(10).fill('<th class="num t-n">?</th>').join('');
                for(let i=0; i<10; i++) document.getElementById('sn-'+i).innerText = '?';
                return;
            }
            document.getElementById('top-nums').innerHTML = n.t.map(v => `<th class="num t-n">${v}</th>`).join('');
            n.s.forEach((v, i) => document.getElementById('sn-'+i).innerText = v);
            refreshWin();
        });

        db.ref('score').on('value', s => { 
            const sc = s.val() || {t:0, s:0};
            document.getElementById('s-top').value = sc.t; document.getElementById('s-side').value = sc.s;
            refreshWin();
        });

        db.ref('history').on('value', s => { 
            const h = s.val() || {};
            for(let i=1; i<=4; i++) if(h[i]) document.getElementById('h'+i).innerHTML = `<b>${h[i].name}</b> (${h[i].score})`;
        });

        function updatePot() {
            const total = (parseFloat(document.getElementById('edit-price').value) || 0) * 100;
            const perc = (document.getElementById('payout-split').value || "25,25,25,25").split(',').map(Number);
            document.getElementById('total-pot').innerText = '$' + total;
            perc.forEach((p, i) => document.getElementById('p'+(i+1)).innerText = '$' + ((p/100)*total).toFixed(0));
        }

        db.ref('chat').limitToLast(10).on('value', snap => {
            const d = document.getElementById('chat-display'); d.innerHTML = '';
            snap.forEach(c => { d.innerHTML += `<div><b>${c.val().name}:</b> ${c.val().msg}</div>`; });
            d.scrollTop = d.scrollHeight;
        });

        function refreshWin() {
            const tD = (document.getElementById('s-top').value || "").toString().slice(-1);
            const sD = (document.getElementById('s-side').value || "").toString().slice(-1);
            document.querySelectorAll('td').forEach(td => td.classList.remove('winner'));
            if(tD === "" || sD === "") return;
            const tI = Array.from(document.querySelectorAll('.t-n')).findIndex(e => e.innerText == tD);
            const sI = Array.from(document.querySelectorAll('.s-n')).findIndex(e => e.innerText == sD);
            if(tI > -1 && sI > -1) {
                const target = document.getElementById('q'+sI+tI);
                if(target) target.parentElement.classList.add('winner');
            }
        }
    </script>
</body>
</html>